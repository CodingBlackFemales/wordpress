"use strict";var WPForms=window.WPForms||{};WPForms.Admin=WPForms.Admin||{},WPForms.Admin.Builder=WPForms.Admin.Builder||{},WPForms.Admin.Builder.FieldLayout=WPForms.Admin.Builder.FieldLayout||function(s){let a={};const u={init:function(){s(u.ready)},ready:function(){u.setup(),u.initLabels(),u.events()},setup:function(){a={$builder:s("#wpforms-builder"),$fieldOptions:s("#wpforms-field-options"),$sortableFieldsWrap:s("#wpforms-panel-fields .wpforms-field-wrap")}},events:function(){a.$builder.on("click",".wpforms-layout-column-placeholder",u.columnPlaceholderClick).on("change",".wpforms-field-option-row-preset input",u.presetChange).on("mouseenter",".wpforms-field-layout .wpforms-field",u.subfieldMouseEnter).on("mouseleave",".wpforms-field-layout .wpforms-field",u.subfieldMouseLeave).on("wpformsFieldAddDragStart",u.fieldCantAddModal).on("wpformsFieldAdd",u.fieldAdd).on("wpformsBeforeFieldAddToDOM",u.beforeFieldAddToDOM).on("wpformsBeforeFieldAddOnClick",u.beforeFieldAddOnClick).on("wpformsBeforeFieldDelete",u.beforeFieldDelete).on("wpformsBeforeFieldDeleteAlert",u.adjustDeleteFieldAlert).on("wpformsFieldOptionTabToggle",u.fieldOptionsUpdate).on("wpformsFieldMoveRejected",u.fieldMoveRejected).on("wpformsBeforeFieldDuplicate",u.beforeFieldDuplicate).on("wpformsFieldDuplicated",u.fieldDuplicated)},columnPlaceholderClick:function(e){e.stopPropagation();var e=s(this).closest(".wpforms-layout-column"),o=e.hasClass("wpforms-fields-sortable-default");a.$sortableFieldsWrap.find(".wpforms-layout-column").removeClass("wpforms-fields-sortable-default"),e.toggleClass("wpforms-fields-sortable-default",!o),WPFormsBuilder.fieldTabToggle("add-fields")},presetChange:function(e){var o=s(this),l=o.val(),o=o.closest(".wpforms-field-option-row-preset").data("field-id"),i=s("#wpforms-field-"+o),t=i.find(".wpforms-field-layout-columns");let d=[],r=(t.find(".wpforms-layout-column").each(function(e){d[e]=s(this).find(".wpforms-field").detach()}),u.getFieldColumnsData(o)),n=l.split("-").map(function(e,o){return{width_preset:e,fields:r[o]?r[o].fields:[]}});if(u.updateFieldColumnsData(o,n),t.html(u.generatePreviewColumns(n)),t.find(".wpforms-layout-column").each(function(e){var o=s(this);o.append(d[e]),WPForms.Admin.Builder.DragFields.initSortableContainer(o)}),n.length<r.length){let o=s([]);for(let e=n.length;e<r.length;e++)o=o.add(d[e]);i.after(o)}u.reorderLayoutFieldsOptions(i),a.$builder.trigger("wpformsLayoutAfterPresetChange",{fieldId:o,preset:l,newColumnsData:n,oldColumnsData:r})},generatePreviewColumns:function(e){if(!e||!e.length)return"";const o=wp.template("wpforms-layout-field-column-plus-placeholder-template")();return e.map(function(e){return`<div class="wpforms-layout-column wpforms-layout-column-${e.width_preset}">
							${o}
						</div>`}).join("")},getFieldColumnsData:function(e){let o=s(`#wpforms-field-option-${e}-columns-json`).val(),l;try{l=JSON.parse(o)}catch(e){l=[]}return l},columnsHasFieldID:function(e,o){return 0<u.getFieldColumnsData(e).filter(function(e){return e.fields.includes(o)}).length},updateFieldColumnsData:function(e,o){var l=s(`#wpforms-field-option-${e}-columns-json`),i=l.val(),t=JSON.stringify(o);l.val(t),i!==t&&a.$builder.trigger("wpformsLayoutColumnsDataUpdated",{fieldId:e,data:o}),a.$builder.trigger("wpformsLayoutAfterUpdateColumnsData",{fieldId:e,data:o})},beforeFieldAddToDOM:function(e,o,l,i,t){t&&t.length&&t.hasClass("wpforms-layout-column")&&(e.skipAddFieldToBaseLevel=!0,u.fieldAddToColumn(l,i,o.position,t))},fieldAdd:function(e,o,l){var i=s("#wpforms-field-option-"+o).prev();"layout"===i.find(".wpforms-field-option-hidden-type").val()&&(i=i.find(".wpforms-field-option-hidden-id").val(),u.reorderLayoutFieldsOptions(s("#wpforms-field-"+i))),"layout"===l&&a.$builder.find(`#wpforms-field-${o} .wpforms-layout-column`).each(function(){WPForms.Admin.Builder.DragFields.initSortableContainer(s(this))})},beforeFieldAddOnClick:function(e,o,l){u.fieldCantAddModal(e,o,{}),e.isDefaultPrevented()||u.isFieldAllowedInColum(o)||a.$sortableFieldsWrap.find(".wpforms-fields-sortable-default").length&&(e.preventDefault(),u.fieldMoveRejected(e,l,null))},beforeFieldDelete:function(e,o,l){"layout"!==l?(u.removeFieldFromColumns(o),s("#wpforms-field-"+o).closest(".wpforms-field-layout").removeClass("wpforms-field-child-hovered")):u.getFieldColumnsData(o).forEach(function(e){Array.isArray(e.fields)&&e.fields.forEach(function(e){WPFormsBuilder.fieldDeleteById(e)})})},adjustDeleteFieldAlert:function(e,o,l){"layout"===l&&(e.preventDefault(),s.confirm({title:!1,content:wpforms_builder.layout.delete_confirm,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"],action:function(){WPFormsBuilder.fieldDeleteById(o.id)}},cancel:{text:wpforms_builder.cancel}}}))},fieldOptionsUpdate:function(e,o){u.fieldLegacyLayoutSelectorUpdate(o),u.fieldSizeOptionUpdate(o),u.fieldOptionGroupsToggle(o)},fieldLegacyLayoutSelectorUpdate:function(e){var o,e=s(`#wpforms-field-option-row-${e}-css .layout-selector-display`);e.find(".wpforms-alert-layout").length||(o=s(`
				<div class="wpforms-alert-warning wpforms-alert-layout wpforms-alert wpforms-alert-nomargin">
					<h4>${wpforms_builder.layout.legacy_layout_notice_title}</h4>
					<p>${wpforms_builder.layout.legacy_layout_notice_text}</p>
				</div>
			`),e.append(o),e.find(".heading, .layouts").addClass("wpforms-hidden-strict"))},fieldSizeOptionUpdate:function(e){var o=s("#wpforms-field-"+e),l=o.data("field-type"),o=0<o.closest(".wpforms-field-layout").length,e=s(`#wpforms-field-option-row-${e}-size`),i=e.find("select");let t=e.find(".wpforms-notice-field-size");-1<["textarea","richtext"].indexOf(l)||(t.length||(t=s(`
					<label class="sub-label wpforms-notice-field-size" title="${wpforms_builder.layout.size_notice_tooltip}">
						${wpforms_builder.layout.size_notice_text}
					</label>
				`),e.append(t)),o?i.attr("title",wpforms_builder.layout.size_notice_tooltip):i.attr("title",""),i.toggleClass("wpforms-disabled",o),t.toggleClass("wpforms-hidden",!o))},fieldOptionGroupsToggle:function(e){e=s("#wpforms-field-"+e).data("field-type");a.$fieldOptions.toggleClass("wpforms-hide-options-groups","layout"===e)},receiveFieldToColumn:function(e,o,l){u.removeFieldFromColumns(e),l&&l.hasClass("wpforms-layout-column")&&(u.positionFieldInColumn(e,o,l),u.fieldOptionsUpdate(null,e),a.$builder.trigger("wpformsLayoutAfterReceiveFieldToColumn",{fieldId:e,position:o,column:l}))},removeFieldFromColumns:function(l){l=Number(l),a.$builder.find(".wpforms-field").each(function(){var e=s(this);if("layout"===e.data("field-type")){var e=Number(e.data("field-id")),o=u.getFieldColumnsData(e);for(let e=0;e<o.length;e++)Array.isArray(o[e].fields)&&(o[e].fields=o[e].fields.filter(function(e){return Number(e)!==l}));u.updateFieldColumnsData(e,o)}})},positionFieldInColumn:function(o,e,l){var i,t,d;l&&l.hasClass("wpforms-layout-column")&&(i=l.closest(".wpforms-field-layout").data("field-id"),l=l.index(),t=u.getFieldColumnsData(i))&&t[l]&&((d=t[l]).fields=Array.isArray(d.fields)?d.fields:[],o=Number(o),d.fields=d.fields.filter(function(e){return Number(e)!==o}),d.fields.splice(e,0,o),t[l]=d,u.updateFieldColumnsData(i,t))},duplicateLayoutField:function(e){var o=s("#wpforms-field-"+e),l=s(`#wpforms-field-option-${e} .wpforms-field-option-row-preset input:checked`).val();if("layout"===o.data("field-type")){const i=u.getFieldColumnsData(e),t=WPFormsBuilder.fieldDuplicateRoutine(e),r=s("#wpforms-field-"+t),n=s("#wpforms-field-option-"+t),f=r.find(".wpforms-layout-column");let d=JSON.parse(JSON.stringify(i));n.find(`#wpforms-field-option-${t}-preset-`+l).prop("checked",!0),r.find(".wpforms-layout-column .wpforms-field").remove(),r.find(".wpforms-fields-sortable-default").removeClass("wpforms-fields-sortable-default"),i.forEach(function(e,i){d[i].fields=[];let t=f.eq(i);e.fields.forEach(function(e){var o,l=s("#wpforms-field-"+e);l.length&&l.find("> .wpforms-field-duplicate").length&&(l=WPFormsBuilder.fieldDuplicateRoutine(e),e=s("#wpforms-field-"+l).detach().removeClass("active"),o=s("#wpforms-field-option-"+l),t.append(e),o.hide(),d[i].fields.push(l))})}),u.updateFieldColumnsData(t,d),u.reorderLayoutFieldsOptions(r),r.trigger("click"),WPFormsUtils.triggerEvent(a.$builder,"wpformsFieldDuplicated",[e,o,t,r])}},subfieldMouseEnter:function(e){s(this).closest(".wpforms-field-layout").addClass("wpforms-field-child-hovered")},subfieldMouseLeave:function(e){s(this).closest(".wpforms-field-layout").removeClass("wpforms-field-child-hovered")},initLabels:function(){s(".wpforms-field-option-layout .wpforms-field-option-row-label input").trigger("input")},fieldAddToColumn:function(e,o,l,i){var t=i.find(".wpforms-field"),t=("bottom"===l&&(l=t.length),t.eq(l)),d=t.data("field-id"),t=(t.length?t.before(e):i.append(e),s("#wpforms-field-option-"+d));t.length?t.before(o):a.$fieldOptions.append(o),u.receiveFieldToColumn(e.data("field-id"),l,i),u.reorderLayoutFieldsOptions(i.closest(".wpforms-field-layout"))},fieldMoveRejected:function(e,o,l){var i=o.data("field-type"),i=(i?s("#wpforms-add-fields-"+i):o).text();s.confirm({title:wpforms_builder.heads_up,content:wpforms_builder.layout.not_allowed_alert_text.replace(/%s/g,`<strong>${i}</strong>`),icon:"fa fa-exclamation-circle",type:"red",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"]}}})},fieldCantAddModal:function(o,e,l){if("layout"===e){let e="";""!==(e=s("#wpforms-panel-field-settings-conversational_forms_enable").is(":checked")?wpforms_builder.layout.enabled_cf_alert_text:e)&&(o.preventDefault(),s.confirm({title:wpforms_builder.heads_up,content:e,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"]}}}))}},reorderLayoutFieldsOptions:function(e){if(e&&e.length&&"layout"===e.data("field-type")){const o=e.data("field-id"),l=u.getFieldColumnsData(o);let t=s("#wpforms-field-option-"+o);l.forEach(function(e,o){if(Array.isArray(e.fields)){let i=e.fields.slice();e.fields.forEach(function(e,o){let l=s("#wpforms-field-option-"+e);l.length?(l=l.detach(),t.after(l),t=l):-1!==(e=i.indexOf(e))&&i.splice(e,1)}),e.fields=i,l[o]=e}}),u.updateFieldColumnsData(o,l)}},isFieldAllowedInColum:function(e){return wpforms_builder.layout.not_allowed_fields.indexOf(e)<0},beforeFieldDuplicate:function(e,o,l){"layout"===l.data("field-type")&&(e.preventDefault(),u.duplicateLayoutField(o),WPFormsBuilder.increaseNextFieldIdAjaxRequest())},fieldDuplicated:function(e,o,l,i,t){"layout"!==l.data("field-type")&&u.positionFieldInColumn(i,t.index()-1,t.parent())}};return u}((document,window,jQuery)),WPForms.Admin.Builder.FieldLayout.init();
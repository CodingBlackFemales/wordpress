export default function(s,n){const o=wpforms_ai_form_generator,r={el:{},init(){r.initState(),r.initElementsCache(),r.initStateProxy(),s.state.panelAdd=!0,s.preview.init(),s.modals.init(),r.events(),r.maybeOpenPanel()},initState(){s.state={formId:n("#wpforms-builder-form").data("id"),panelAdd:!1,panelOpen:!1,chatStart:!1,aiResponse:null}},events(){r.el.$setupPanel.on("click",".wpforms-template-generate",r.event.clickGenerateFormBtn).on("click",".wpforms-template-generate-install-addons",s.modals.openAddonsModal),r.el.$generatorPanel.on("click",".wpforms-btn-back-to-templates",r.event.clickBackToTemplatesBtn).on("click",".wpforms-ai-chat-reload-link",r.event.reloadPage).on("click",".wpforms-ai-chat-use-form",r.event.useForm),r.el.$builder.on("wpformsPanelSwitch",r.event.panelSwitch),r.el.$doc.on("wpformsAIChatBeforeAddAnswer",r.event.chatBeforeAddAnswer).on("wpformsAIChatAddedAnswer",r.event.chatAddedAnswer).on("wpformsAIChatAfterRefresh",r.event.chatAfterRefresh).on("wpformsAIChatSetActiveAnswer",r.event.chatSetActiveAnswer)},initElementsCache(){r.el.$doc=n(document),r.el.$builder=n("#wpforms-builder"),r.el.$builderToolbar=n("#wpforms-builder .wpforms-toolbar"),r.el.$templatesList=n("#wpforms-setup-templates-list .list"),r.el.$templateCard=n("#wpforms-template-generate"),r.el.$generatorPanel=n("#wpforms-panel-ai-form"),r.el.$setupPanel=n("#wpforms-panel-setup"),r.el.$panelsContainer=n(".wpforms-panels"),r.el.$allPanels=n(".wpforms-panel"),r.el.$chat=r.el.$generatorPanel.find("wpforms-ai-chat .wpforms-ai-chat")},initStateProxy(){s.state=new Proxy(s.state,{set(e,t,a){return e[t]=a,"function"==typeof r.setStateHandler[t]&&(r.setStateHandler[t](a),wpf.debug("Form Generator state changed:",t,"=",a)),!0}})},event:{clickGenerateFormBtn(e){e.preventDefault(),s.state.panelOpen=!0},clickBackToTemplatesBtn(){s.state.panelOpen=!1},chatBeforeAddAnswer(e){s.state.aiResponse=e.originalEvent.detail?.response,s.state.aiResponseHistory=s.state.aiResponseHistory||{},s.state.aiResponseHistory[s.state.aiResponse?.responseId]=s.state.aiResponse},chatAddedAnswer(e){(e.originalEvent.detail?.chat||{})?.sessionId&&!s.state.chatStart&&(s.state.chatStart=!0)},chatAfterRefresh(){s.preview.clear()},chatSetActiveAnswer(e){s.state.aiResponse=s.state.aiResponseHistory[e.originalEvent.detail?.responseId]},useForm(e){e?.preventDefault();e=n(this);s.state.formId&&"generate"!==wpforms_builder.template_slug?s.modals.openExistingFormModal(e):r.useFormAjax(e)},reloadPage(e){e?.preventDefault(),window.location=window.location+"&ai-form"},panelSwitch(){s.state.panelOpen=!1}},setStateHandler:{panelAdd(e){e?r.el.$generatorPanel?.length||(r.el.$panelsContainer.append(r.render.generatorPanel()),r.el.$generatorPanel=n("#wpforms-panel-ai-form"),r.el.$chat=r.el.$generatorPanel.find("wpforms-ai-chat .wpforms-ai-chat")):r.el.$generatorPanel?.remove()},panelOpen(e){var t;r.el.$generatorPanel.toggleClass("active",e),r.el.$templateCard.addClass("selected"),r.setToolbarState(e),!s.state.aiResponseHistory&&wpforms_ai_chat_element.forms.responseHistory&&(s.state.aiResponseHistory=wpforms_ai_chat_element.forms.responseHistory,t=(e=r.el.$chat.find(".wpforms-chat-item-answer.active")).data("response-id"),s.state.aiResponse=s.state.aiResponseHistory[t],e[0].scrollIntoView({behavior:"smooth",block:"end"}))},chatStart(e){e&&r.el.$templateCard.addClass("selected").find(".wpforms-template-generate").text(o.templateCard.buttonTextContinue)},aiResponse(e){e&&s.preview.update()},isPreviewUpdate(e){r.el.$chat.toggleClass("wpforms-ai-chat-inactive",e)}},render:{generatorPanel(){return`
					<div class="wpforms-panel wpforms-panel-fields" id="wpforms-panel-ai-form">
						<div class="wpforms-panel-sidebar-content">
							<div class="wpforms-panel-sidebar">
								<div class="wpforms-panel-sidebar-header">
									<button type="button" class="wpforms-btn-back-to-templates" aria-label="${o.panel.backToTemplates}">
										${o.panel.backToTemplates}
									</button>
								</div>
								<wpforms-ai-chat mode="forms" class="wpforms-ai-chat-blue"/>
							</div>
							<div class="wpforms-panel-content-wrap">
								<div class="wpforms-panel-content">
									<div class="wpforms-panel-empty-state">
										<h4>${o.panel.emptyStateTitle}</h4>
										<p>${o.panel.emptyStateDesc}</p>
									</div>
								</div>
							</div>
						</div>
					</div>
				`}},maybeOpenPanel(){window.location.search.includes("&ai-form")&&(history.replaceState({},null,wpf.updateQueryString("ai-form",null)),!Object.keys(o.addonsData).length||o.dismissed.installAddons?s.state.panelOpen=!0:s.modals.openAddonsModal(null))},useFormAjax(e){var t=e.closest(".wpforms-ai-chat").data("session-id"),a=e.closest(".wpforms-chat-item").data("response-id"),a=(WPFormsBuilder.showLoadingOverlay(),r.getChatElement()?.wpformsAiApi.rate(!0,a),WPFormsBuilder.setCloseConfirmation(!1),{action:"wpforms_use_ai_form",nonce:o.nonce,formId:s.state.formId,formData:s.state.aiResponseHistory[a],sessionId:t,chatHtml:e.closest("wpforms-ai-chat").html(),responseHistory:s.state.aiResponseHistory});s.preview.closeTooltips(),n.post(o.ajaxUrl,a).done(function(e){e.success?window.location.assign(e.data.redirect):wpf.debug("Form Generator AJAX error:",e.data.error??e.data)}).fail(function(e){wpf.debug("Form Generator AJAX error:",e.responseText??e.statusText)})},setToolbarState(e){r.el.$builderToolbar.toggleClass("empty",e),r.el.$builderToolbar.find("#wpforms-help span").toggleClass("screen-reader-text",!e)},getChatElement(){return r.el.$chat.parent()[0]}};return r}
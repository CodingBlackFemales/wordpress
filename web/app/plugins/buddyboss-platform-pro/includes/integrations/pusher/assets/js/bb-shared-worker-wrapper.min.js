window.bp=window.bp||{},window.Backbone=window.Backbone||[],bp,jQuery,bp.bb_pusher_shared={constructor:function(e,s){return this.app_key=e,this.options=s,this.worker=!1,this.bind_callbacks=[],this.channels="",bp.bb_pusher_shared.startWorker(),bp.bb_pusher_shared},startWorker:function(){var s;this.worker||(this.worker=new SharedWorker(bb_pusher_vars.bb_pro_pusher_shared_worker_url+"?v="+bb_pusher_vars.bb_pro_version,"Shared Worker"),this.worker.port.start(),(s=this).worker.port.onmessage=function(e){s.onMessage(e)},bp.bb_pusher_shared.sendMessage("pusher_init",{app_key:this.app_key,options:this.options}))},sendMessage:function(e,s){this.worker.port.postMessage({type:e,data:s,current_user_id:bb_pusher_vars.loggedin_user_id})},onMessage:function(e){var s=e.data;switch(s.type){case"pusher_init":break;case"pusher_event":bp.bb_pusher_shared.triggerBinds(s);break;case"pusher_channels":bp.bb_pusher_shared.updateChannels(s);break;case"before-message-ajax-send":bp.bb_pusher_shared.onSendMessage(s);break;case"resend-message-ajax-send":bp.bb_pusher_shared.onResendMessage(s);break;case"renderAjaxUpdateFailedMessage":bp.bb_pusher_shared.renderAjaxUpdateFailedMessage(s);break;case"onCancelRemoveMessage":bp.bb_pusher_shared.onCancelRemoveMessage(s)}},updateChannels:function(e){this.channels=e.data.channels},onSendMessage:function(e){bp.Pusher_FrontCommon.renderMessage(e.data.data)},onResendMessage:function(e){bp.Pusher_FrontCommon.renderUpdateSendingMessage(e.data.data)},renderAjaxUpdateFailedMessage:function(e){bp.Pusher_FrontCommon.renderAjaxUpdateFailedMessage(e.data.data)},onCancelRemoveMessage:function(e){window.Backbone.trigger("onCancelRemoveMessage",e.data.data),window.Backbone.trigger("relistelements")},triggerBinds:function(s){void 0!==this.bind_callbacks[s.data.channel_name]&&void 0!==this.bind_callbacks[s.data.channel_name][s.data.event]&&s.data.user_id===bb_pusher_vars.loggedin_user_id&&this.bind_callbacks[s.data.channel_name][s.data.event].forEach(function(e){e(s.data.data)})},subscribe:function(a){bp.bb_pusher_shared.sendMessage("pusher_subscribe",{channel_name:a});var n=this;return{bind:function(e,s){void 0===n.bind_callbacks[a]&&(n.bind_callbacks[a]=[]),void 0===n.bind_callbacks[a][e]&&(n.bind_callbacks[a][e]=[]),n.bind_callbacks[a][e].push(s)},trigger:function(e,s){n.sendMessage("pusher_send_event",{channel_name:a,event:e,data:s,loggedin_user_id:bb_pusher_vars.loggedin_user_id})}}},unsubscribe:function(e){bp.bb_pusher_shared.sendMessage("pusher_unsubscribe",{channel_name:e,loggedin_user_id:bb_pusher_vars.loggedin_user_id})}};